#!/bin/bash

set -x

cd /root
mkdir provisioning
cd provisioning

apt-get update

# papertrail for the dokku rsyslog and vhost proxy

export PAPERTRAIL_PORT=<%= ENV['PAPERTRAIL_PORT'] %>
apt-get install -y -q ruby1.9.1-dev build-essential
gem install remote_syslog
echo '$PreserveFQDN on' > /etc/rsyslog.d/00-preserve-fqdn.conf
echo "*.*          @logs.papertrailapp.com:$PAPERTRAIL_PORT" > /etc/rsyslog.d/999-papertrail.conf
service rsyslog restart
killall remote_syslog
remote_syslog -p $PAPERTRAIL_PORT -d logs.papertrailapp.com /var/log/nginx/access.log /var/log/nginx/error.log

# nsenter

if [ ! -f /usr/local/bin/nsenter ]; then
    cd /tmp
    curl https://www.kernel.org/pub/linux/utils/util-linux/v2.24/util-linux-2.24.tar.gz \
         | tar -zxf-
    cd util-linux-2.24
    ./configure --without-ncurses
    make nsenter
    cp nsenter /usr/local/bin/
fi


cd /root
